version: '3.8'
services:
    mysql:
      image: percona/percona-server:5.7
      #container_name: bx-mysql
      hostname: mysql
      healthcheck:
        test: "/usr/bin/mysql --user=root --password=${BX_MYSQL_ROOT_PASS} --execute \"SHOW DATABASES;\""
        interval: 2s
        timeout: 20s
        retries: 10
      networks:
        - bitrix
      ports:
        - "3306:3306"
      environment:
        MYSQL_ROOT_PASSWORD: ${BX_MYSQL_ROOT_PASS}
        MYSQL_DATABASE: ${BX_MYSQL_DB}
        MYSQL_USER: bitrix
        MYSQL_PASSWORD: ${BX_MYSQL_BITRIX_PASS}
      volumes:
        - ./volumes/mysql:/var/lib/mysql
      command: ['--innodb_strict_mode=OFF','--character-set-server=utf8', '--collation-server=utf8_unicode_ci',
         '--skip-character-set-client-handshake', '--sql-mode=']

    web:
      build:
        context: ./services/web
        dockerfile: dockerfile
     
      hostname: web
      #ports:
        #- 80:80
        #- 8893-8895:8893-8895/tcp
        #- 443:443
      networks:
        - bitrix
#          ipv4_address: 172.16.16.4
      depends_on:
        - mysql
        - push
      volumes:
        - ./volumes/www/:/var/www/html/bx-site/
        - ./services/web/logs/crond:/var/log/crond
        - ./services/web/logs/httpd:/var/log/httpd
        - ./services/web/logs/php:/var/log/php
        - ./services/web/logs/supervisor:/var/log/supervisor
        - ./services/web/cron/bitrix:/etc/cron.d/bitrix
      #command: ["/root/entry-web.sh"]
      environment:
        USER_ID: $USER_ID
      entrypoint: [ "/entrypoint.sh" ]
    
    nginx:
      build:
        context: ./services/web/nginx
      ports:
        - 80:80
        - 443:443
        #открываем, если нужен доступ снаружи для push
        #- 8893-8895:8893-8895
      networks:
        - bitrix
  #          ipv4_address: 172.16.16.4
      depends_on:
        - web
      volumes:
        - ./services/web/logs/nginx:/var/log/nginx
        - ./volumes/www/:/var/www/html/bx-site/
      #entrypoint: [ "/entrypoint.sh" ]
      

    redis:
      build: 
        context: ./services/redis
        dockerfile: dockerfile
      networks:
        - bitrix
      volumes:
        - redis-sock:/tmp/
        #- ./services/tmp/:/tmp/
    push:
      build:
        context: ./services/push
        dockerfile: dockerfile
      hostname: push
      environment:
        USER_ID: $USER_ID
      volumes:
        - redis-sock:/tmp/
        #- ./services/tmp/:/tmp/
        - ./services/push/logs:/var/log/
        - ./services/push/supervisor/supervisord.ini:/etc/supervisord.d/supervisord.ini
      #ports:
        #- 8010-8015:8010-8015/tcp
        #- 9010-9011:9010-9011/tcp
      networks:
        - bitrix
#          ipv4_address: 172.16.16.4
      depends_on:
        - redis
      entrypoint:  [ "/entrypoint.sh" ]

volumes: 
  redis-sock:      
    

networks:
  bitrix:
#    name: bitrix_net
#    ipam:
#      config:
#        - subnet: 172.16.16.0/24

    